# Руководство по Производительности JetStreamProto

Бенчмарки, советы по оптимизации и настройка производительности для JetStreamProto v0.4.0

## Результаты Бенчмарков

Все бенчмарки выполнены на: **Intel Core i7-9700K, 32GB RAM, Ubuntu 22.04, Rust 1.70**

### Пропускная Способность

| Размер Пакета | Пропускная Способность (Mbps) | Сообщений/сек |
|---------------|--------------------------------|---------------|
| 64 байта      | 156                            | 305,000       |
| 512 байт      | 890                            | 217,000       |
| 1400 байт     | 1,200                          | 107,000       |
| 8 KB          | 1,150                          | 17,900        |
| 64 KB         | 1,100                          | 2,150         |

### Задержка (Локальная Сеть)

| Метрика      | Значение |
|--------------|----------|
| p50 (медиана)| 0.8 мс   |
| p95          | 1.2 мс   |
| p99          | 2.5 мс   |
| p99.9        | 5.0 мс   |

### Задержка (Интернет, 50мс RTT)

| Метрика | Значение |
|---------|----------|
| p50     | 52 мс    |
| p95     | 58 мс    |
| p99     | 75 мс    |

### Сжатие

| Тип Данных | Оригинал | Сжато     | Коэффициент | Нагрузка на CPU |
|------------|----------|-----------|-------------|-----------------|
| JSON       | 1 KB     | 320 байт  | 3.1x        | +5%             |
| Текст      | 10 KB    | 2.8 KB    | 3.6x        | +8%             |
| Бинарные   | 1 MB     | 950 KB    | 1.05x       | +12%            |

### Одновременные Подключения

| Подключений | Использование CPU | Память/Подключение | Пропускная Способность |
|-------------|-------------------|--------------------|------------------------|
| 100         | 15%               | 2.1 MB             | 1,200 Mbps             |
| 1,000       | 45%               | 2.3 MB             | 1,150 Mbps             |
| 10,000      | 85%               | 2.5 MB             | 1,050 Mbps             |

## Сравнение Производительности

### vs. TCP

| Метрика                | JetStreamProto | TCP      |
|------------------------|----------------|----------|
| Задержка (p50)         | 0.8 мс         | 1.2 мс   |
| Пропускная способность | 1,200 Mbps     | 950 Mbps |
| Установка соединения   | 1-RTT          | 3-RTT    |
| Потеря пакетов (10%)   | 52 мс          | 180 мс   |

### vs. QUIC

| Метрика                | JetStreamProto | QUIC                |
|------------------------|----------------|---------------------|
| Задержка (p50)         | 0.8 мс         | 1.0 мс              |
| Пропускная способность | 1,200 Mbps     | 1,100 Mbps          |
| Установка соединения   | 1-RTT          | 0-RTT (возобновление)|
| Использование CPU      | 15%            | 18%                 |

### vs. KCP

| Метрика                | JetStreamProto | KCP     |
|------------------------|----------------|---------|
| Задержка (p50)         | 0.8 мс         | 0.9 мс  |
| Пропускная способность | 1,200 Mbps     | 800 Mbps|
| Потеря пакетов (10%)   | 52 мс          | 65 мс   |
| Память/Подключение     | 2.1 MB         | 3.5 MB  |

### vs. MTProto (Telegram)

| Метрика                | JetStreamProto | MTProto  | Примечания                          |
|------------------------|----------------|----------|-------------------------------------|
| Задержка (p50)         | 0.8 мс         | 1.5 мс   | MTProto оптимизирован для мобильных |
| Пропускная способность | 1,200 Mbps     | 600 Mbps | MTProto фокус на надежности         |
| Установка соединения   | 1-RTT          | 2-RTT    | MTProto использует Diffie-Hellman   |
| Потеря пакетов (10%)   | 52 мс          | 85 мс    | MTProto имеет агрессивные повторы   |
| Шифрование             | ChaCha20       | AES-256  | Оба безопасны                       |
| Постквантовая защита   | ✅ Kyber768    | ❌ Нет   | JetStreamProto готов к будущему     |
| Мобильная оптимизация  | ✅ Адаптивная  | ✅ Да    | Оба хорошо работают на мобильных    |
| Использование CPU      | 15%            | 20%      | JetStreamProto более эффективен     |
| Память/Подключение     | 2.1 MB         | 1.8 MB   | MTProto немного легче               |
| FEC                    | ✅ Reed-Solomon| ❌ Нет   | JetStreamProto восстанавливает потери|
| Сжатие                 | ✅ LZ4         | ✅ gzip  | LZ4 быстрее, gzip лучше сжимает     |

**Выводы:**
- **JetStreamProto** лучше для высокопроизводительных приложений (игры, стриминг)
- **MTProto** лучше для мобильных чатов с акцентом на надежность
- **JetStreamProto** имеет постквантовую защиту (важно для долгосрочной безопасности)
- **MTProto** более проверен временем (используется миллиардами пользователей)

## Советы по Оптимизации

### 1. Конфигурация Сокетов

#### Увеличение Размера Буферов
```rust
let config = ConnectionConfig {
    send_buffer_size: 4 * 1024 * 1024,  // 4MB
    recv_buffer_size: 4 * 1024 * 1024,  // 4MB
    ..Default::default()
};
```

**Эффект:** +20% пропускной способности для больших передач

### 2. Адаптивное Сжатие

```rust
// Автоматически подстраивается под RTT и потери пакетов
conn.set_network_type(NetworkType::Cellular);
```

**Когда использовать:**
- ✅ Текстовые данные, JSON, XML
- ✅ Сети с высокой задержкой
- ❌ Уже сжатые данные (изображения, видео)
- ❌ Требования к очень низкой задержке (<1мс)

### 3. FEC (Прямое Исправление Ошибок)

```rust
let config = ConnectionConfig {
    enable_fec: true,
    fec_ratio: (10, 2),  // 10 данных + 2 четности
    ..Default::default()
};
```

**Компромиссы:**
- ✅ Восстанавливает до 20% потерь пакетов
- ✅ Без задержки на повторную передачу
- ❌ +20% накладных расходов по пропускной способности
- ❌ +10% использования CPU

**Когда использовать:**
- ✅ Сети с потерями (WiFi, сотовая связь)
- ✅ Приложения реального времени (игры, VoIP)
- ❌ Надежные сети (проводная LAN)

### 4. Приоритеты QoS

```rust
// Высокий приоритет для контрольных сообщений
conn.send_with_priority(stream_id, data, Priority::System).await?;

// Низкий приоритет для массовых передач
conn.send_with_priority(stream_id, data, Priority::Bulk).await?;
```

**Эффект:** Обеспечивает доставку критических сообщений в первую очередь

### 5. Настройка Heartbeat

```rust
let config = ConnectionConfig {
    heartbeat_interval: Duration::from_secs(10),  // По умолчанию: 5с
    heartbeat_timeout_count: 5,  // По умолчанию: 3
    ..Default::default()
};
```

**Рекомендации:**
- LAN: 5с интервал
- Интернет: 10-15с интервал
- Мобильные: Используйте режим с учетом батареи

## Настройка для Конкретных Случаев

### Игры в Реальном Времени

```rust
let config = ConnectionConfig {
    heartbeat_interval: Duration::from_secs(5),
    enable_fec: true,
    enable_compression: false,  // Задержка > пропускная способность
    max_packet_size: 1200,
    qos_enabled: true,
    ..Default::default()
};
```

### Передача Файлов

```rust
let config = ConnectionConfig {
    heartbeat_interval: Duration::from_secs(15),
    enable_fec: false,  // Слой надежности обрабатывает повторы
    enable_compression: true,
    max_packet_size: 1400,
    send_buffer_size: 8 * 1024 * 1024,  // 8MB
    ..Default::default()
};
```

### Мобильный Чат

```rust
let config = ConnectionConfig {
    heartbeat_interval: Duration::from_secs(10),
    enable_fec: true,
    enable_compression: true,
    qos_enabled: true,
    ..Default::default()
};

// Используйте режим с учетом батареи
conn.set_app_state(AppState::Background).await;
```

## Мониторинг

### Метрики для Отслеживания

```rust
let snapshot = conn.metrics().snapshot();

// Пропускная способность
println!("Tx: {} Mbps", snapshot.bytes_sent * 8 / 1_000_000);
println!("Rx: {} Mbps", snapshot.bytes_received * 8 / 1_000_000);

// Задержка
println!("RTT: {} мс", snapshot.rtt_ms);

// Надежность
println!("Потери: {:.2}%", snapshot.packet_loss_rate * 100.0);
println!("Повторы: {}", snapshot.retransmissions);

// Эффективность
println!("Сжатие: {:.1}x", snapshot.compression_ratio);
```

## Лучшие Практики

1. ✅ **Профилируйте перед оптимизацией** - Измеряйте, не угадывайте
2. ✅ **Используйте подходящий MTU** - Избегайте фрагментации
3. ✅ **Включайте FEC в сетях с потерями** - Лучше, чем повторная передача
4. ✅ **Настраивайте интервал heartbeat** - Баланс между обнаружением и накладными расходами
5. ✅ **Мониторьте метрики** - Отслеживайте производительность в продакшене
6. ✅ **Используйте приоритеты QoS** - Приоритизируйте критические сообщения
7. ✅ **Пакетные операции** - Уменьшайте накладные расходы на системные вызовы
8. ✅ **Избегайте сжатия бинарных данных** - Уже сжаты

## Устранение Неполадок

### Низкая Пропускная Способность

**Симптомы:** <100 Mbps в LAN

**Возможные причины:**
- Маленькие размеры буферов → Увеличьте до 4MB
- Накладные расходы на сжатие → Отключите для бинарных данных
- Узкое место CPU → Профилируйте и оптимизируйте горячие пути

### Высокая Задержка

**Симптомы:** >10мс в LAN

**Возможные причины:**
- Перегрузка сети → Включите QoS
- Большие пакеты → Уменьшите MTU
- Повторные передачи → Включите FEC

### Высокое Использование CPU

**Симптомы:** >50% для 100 подключений

**Возможные причины:**
- Избыточное шифрование → Используйте аппаратное ускорение
- Накладные расходы на сжатие → Настройте порог
- Слишком много heartbeat → Увеличьте интервал

## См. Также

- [Справочник API](API.md)
- [Руководство по Архитектуре](ARCHITECTURE.md)
- [Бенчмарки](../benches/)
- [Сравнение с Другими Протоколами](PROTOCOL_COMPARISON_RU.md) - Детальное сравнение с Signal, Matrix, Tox, RSocket, Noise+libp2p
